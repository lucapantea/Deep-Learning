#!/bin/bash -l

#SBATCH --partition=gpu_shared_course
#SBATCH --gres=gpu:1
#SBATCH --job-name=CROSS-DATASET-2
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=3
#SBATCH --time=01:00:00
#SBATCH --mem=32000M
#SBATCH --output=slurm_output_%x.out

module purge
module load 2021
module load Anaconda3/2021.05

# activate the environment
source activate ~/.conda/envs/dl2022

# Run 1: Visual prompting CLIP on CIFAR-10 with standard text prompt
code_dir=./
save=./save/models


fixed_cifar10="./save/models/fixed_patch_1_cifar10_clip_ViT-B/32_sgd_lr_40_decay_0_bsz_128_warmup_1000_trial_1/model_best.pth.tar"
fixed_cifar100="./save/models/fixed_patch_1_cifar100_clip_ViT-B/32_sgd_lr_40_decay_0_bsz_128_warmup_1000_trial_1/model_best.pth.tar"

random_cifar10="./save/models/random_patch_1_cifar10_clip_ViT-B/32_sgd_lr_40_decay_0_bsz_128_warmup_1000_trial_1/model_best.pth.tar"
random_cifar100="./save/models/random_patch_1_cifar100_clip_ViT-B/32_sgd_lr_40_decay_0_bsz_128_warmup_1000_trial_1/model_best.pth.tar"

padding_cifar10="./save/models/padding_30_cifar10_clip_ViT-B/32_sgd_lr_40_decay_0_bsz_128_warmup_1000_trial_1/model_best.pth.tar"
padding_cifar100="./save/models/padding_30_cifar100_clip_ViT-B/32_sgd_lr_40_decay_0_bsz_128_warmup_1000_trial_1/model_best.pth.tar"

saved_models=($fixed_cifar10 $fixed_cifar100 $random_cifar10 $random_cifar100 $padding_cifar10 $padding_cifar100)
methods=(fixed_patch fixed_patch random_patch random_patch padding padding)
prompt_sizes=(1 1 1 1 30 30)
datasets=(cifar10 cifar100 cifar10 cifar100 cifar10 cifar100)

for i in "${!saved_models[@]}"; do
    echo "Running robustness experiment on cifar10 + cifar100 with ${saved_models[$i]}."
    python $code_dir/cross_dataset.py \
        --resume "${saved_models[$i]}" \
        --method "${methods[$i]}" \
        --prompt_size "${prompt_sizes[$i]}" \
        --evaluate
done 